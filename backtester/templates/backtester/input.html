{% extends 'backtester/base.html' %}

{% block content %}
<div class="card form-container" style="max-width: 800px;">
    <div class="card-header">
        <h2>Costruisci il Portafoglio</h2>
        <p>Aggiungi gli ETF che compongono il tuo piano.</p>
    </div>

    <form method="post" class="pac-form">
        {% csrf_token %}
        {{ formset.management_form }}

        <div id="form-list">
            {% for form in formset %}
            <div class="pac-row-card fade-in">
                <div class="row-header">
                    <span class="row-title">ETF #{{ forloop.counter }}</span>
                </div>

                <div class="form-grid-compact">
                    <div class="form-group relative-container">
                        <label>Ticker</label>
                        {{ form.ticker }}
                        <!-- Elemento per mostrare il feedback live -->
                        <div class="ticker-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label>Data Inizio</label>
                        {{ form.data_inizio }}
                    </div>
                    <div class="form-group">
                        <label>Investimento Iniziale</label>
                        {{ form.importo_iniziale }}
                    </div>
                    <div class="form-group">
                        <label>Rata</label>
                        {{ form.importo_periodico }}
                    </div>
                    <div class="form-group">
                        <label>Frequenza</label>
                        {{ form.frequenza }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="form-actions-row">
            <button type="button" id="add-btn" class="btn btn-outline">
                + Aggiungi un altro ETF
            </button>
            <button type="submit" class="btn btn-primary">
                Calcola Portafoglio Totale ‚ö°
            </button>
        </div>
    </form>
</div>

<!-- Template Nascosto -->
<div id="empty-form" style="display:none;">
    <div class="pac-row-card fade-in">
        <div class="row-header">
            <span class="row-title">Nuovo ETF</span>
        </div>
        <div class="form-grid-compact">
            <div class="form-group relative-container">
                <label>Ticker</label>
                {{ formset.empty_form.ticker }}
                <div class="ticker-feedback"></div>
            </div>
            <div class="form-group"><label>Data Inizio</label>{{ formset.empty_form.data_inizio }}</div>
            <div class="form-group"><label>Inv. Iniziale</label>{{ formset.empty_form.importo_iniziale }}</div>
            <div class="form-group"><label>Rata</label>{{ formset.empty_form.importo_periodico }}</div>
            <div class="form-group"><label>Frequenza</label>{{ formset.empty_form.frequenza }}</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-btn');
        const formList = document.getElementById('form-list');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        let debounceTimer;

        // 1. Funzione per gestire l'aggiunta di nuovi form
        addBtn.addEventListener('click', function() {
            let formCount = parseInt(totalForms.value);
            const emptyTemplate = document.getElementById('empty-form').innerHTML;
            const newHtml = emptyTemplate.replace(/__prefix__/g, formCount);
            const newDiv = document.createElement('div');
            newDiv.innerHTML = newHtml;
            formList.appendChild(newDiv);
            totalForms.value = formCount + 1;
        });

        // 2. Event Delegation per ascoltare l'input su TUTTI i campi ticker (presenti e futuri)
        formList.addEventListener('input', function(e) {
            if (e.target.classList.contains('ticker-input')) {
                const inputField = e.target;
                const feedbackDiv = inputField.parentElement.querySelector('.ticker-feedback');
                const ticker = inputField.value.trim();

                // Reset visuale
                feedbackDiv.textContent = 'Digitando...';
                feedbackDiv.className = 'ticker-feedback text-gray';

                clearTimeout(debounceTimer);

                if (ticker.length < 3) {
                    feedbackDiv.textContent = '';
                    return;
                }

                // 3. Debounce: aspetta 600ms che l'utente finisca di scrivere
                debounceTimer = setTimeout(() => {
                    feedbackDiv.textContent = 'üîç Cerco...';

                    fetch(`/api/validate-ticker/?ticker=${ticker}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.valid) {
                                feedbackDiv.textContent = '‚úÖ ' + data.name;
                                feedbackDiv.className = 'ticker-feedback text-green';
                            } else {
                                feedbackDiv.textContent = '‚ùå ' + (data.error || 'Non trovato');
                                feedbackDiv.className = 'ticker-feedback text-red';
                            }
                        })
                        .catch(err => {
                            feedbackDiv.textContent = '‚ö†Ô∏è Errore connessione';
                            feedbackDiv.className = 'ticker-feedback text-red';
                        });
                }, 600);
            }
        });
    });
</script>

<style>
    /* Stili per il feedback live */
    .relative-container {
        position: relative;
    }
    .ticker-feedback {
        font-size: 0.75rem;
        margin-top: 4px;
        min-height: 1.2em;
        font-weight: 600;
        transition: all 0.2s;
    }
    .text-green { color: #10b981; }
    .text-red { color: #ef4444; }
    .text-gray { color: #94a3b8; }

    /* CSS esistente per Multi-Row */
    .pac-row-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .row-header {
        margin-bottom: 1rem;
        font-weight: 700;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5rem;
    }
    .form-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
    }
    .form-actions-row {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }
    .btn-outline {
        background: transparent;
        border: 2px solid #e2e8f0;
        color: #475569;
    }
    .btn-outline:hover {
        border-color: #cbd5e1;
        background: #f1f5f9;
    }
</style>
{% endblock %}
