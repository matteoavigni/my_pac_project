{% extends 'backtester/base.html' %}
{% load l10n %}

{% block content %}
<div class="results-header">
    <a href="{% url 'calcolatore' %}" class="btn-back">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Nuova Simulazione
    </a>
    <h1>Performance Portafoglio Totale</h1>
</div>

<!-- KPI CARDS GRID -->
<div class="kpi-grid">
    <!-- 1. CAPITALE INVESTITO -->
    <div class="kpi-card">
        <span class="label">Totale Investito</span>
        <span class="value fmt-currency" data-val="{{ risultato.investito|default:0|unlocalize }}">€ ...</span>
    </div>

    <!-- 2. DIVIDENDI (Cash Flow) -->
    <div class="kpi-card" style="border-left: 4px solid #8b5cf6;">
        <span class="label">Dividendi Incassati (Netto)</span>
        <span class="value fmt-currency" data-val="{{ risultato.dividendi_netti|default:0|unlocalize }}" style="color: #7c3aed;">€ ...</span>
        <span class="sub-value">
            Lordo: <span class="fmt-currency" data-val="{{ risultato.dividendi_lordi|default:0|unlocalize }}"></span>
        </span>
    </div>

    <!-- 3. CAPITAL GAIN (Apprezzamento Quote) -->
    <div class="kpi-card success">
        <span class="label">Profitto da Capitale (Netto)</span>
        <span class="value fmt-currency" data-val="{{ risultato.plusvalenza_netta|default:0|unlocalize }}">€ ...</span>
        <span class="sub-value">
            Lordo: <span class="fmt-currency" data-val="{{ risultato.plusvalenza_lorda|default:0|unlocalize }}"></span>
        </span>
    </div>

    <!-- 4. TOTALE NETTO (Exit Value) -->
    <div class="kpi-card info">
        <span class="label">Valore Finale (Tutto Incluso)</span>
        <span class="value fmt-currency" data-val="{{ risultato.valore_netto|default:0|unlocalize }}">€ ...</span>
        <span class="sub-value">ROI Netto: +{{ risultato.profitto_pct }}%</span>
    </div>
</div>

<!-- GRAFICO -->
<div class="card card-chart">
    <div class="chart-wrapper">
        <canvas id="pacChart"></canvas>
    </div>
</div>

<!-- TABELLA DETTAGLIO ETF -->
<div class="card" style="margin-top: 2rem;">
    <h3>Dettaglio per ETF</h3>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
            <thead>
                <tr style="text-align: left; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 10px;">Ticker</th>
                    <th style="padding: 10px;">Investito</th>
                    <th style="padding: 10px;">Dividendi Netti</th>
                    <th style="padding: 10px;">Capital Gain Netto</th>
                    <th style="padding: 10px;">Profitto Totale</th>
                </tr>
            </thead>
            <tbody>
                {% for item in risultato.dettagli_singoli %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px; font-weight: 600;">
                        {{ item.ticker }}
                        <span style="display:block; font-size: 0.75rem; color: #94a3b8; font-weight:normal;">{{ item.currency }}</span>
                    </td>
                    <td style="padding: 12px;" class="fmt-currency" data-val="{{ item.investito|default:0|unlocalize }}"></td>
                    <td style="padding: 12px; color: #7c3aed;" class="fmt-currency" data-val="{{ item.dividendi_netti|default:0|unlocalize }}"></td>
                    <td style="padding: 12px; color: #10b981;" class="fmt-currency" data-val="{{ item.plusvalenza_netta|default:0|unlocalize }}"></td>
                    <td style="padding: 12px; font-weight: 600; color: {% if item.profitto_netto > 0 %}#10b981{% else %}#ef4444{% endif %};"
                        class="fmt-currency" data-val="{{ item.profitto_netto|default:0|unlocalize }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- NUOVA SEZIONE: TABELLA TOP 5 DRAWDOWN -->
<div class="card" style="margin-top: 2rem; border-left: 4px solid #ef4444;">
    <h3>Analisi Rischio: Top 5 Drawdown</h3>
    <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;">I momenti peggiori vissuti dal portafoglio (dal picco al fondo).</p>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 10px;">Periodo (Picco - Fondo)</th>
                    <th style="padding: 10px;">Perdita %</th>
                    <th style="padding: 10px;">Perdita Monetaria</th>
                </tr>
            </thead>
            <tbody>
                {% for dd in risultato.top_drawdowns %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px; font-weight: 600; color: #334155;">{{ dd.period }}</td>
                    <td style="padding: 12px; color: #ef4444; font-weight: 700;">{{ dd.pct|floatformat:2 }}%</td>
                    <td style="padding: 12px; color: #ef4444;" class="fmt-currency" data-val="{{ dd.euro|default:0|unlocalize }}"></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="padding: 20px; text-align: center; color: #94a3b8;">
                        Nessun drawdown significativo rilevato.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- SCRIPT LOGICA (Invariato) -->
<script>
    document.addEventListener("DOMContentLoaded", function() {

        function formatEuro(number) {
            if (isNaN(number)) return "€ 0,00";
            let isNegative = number < 0;
            number = Math.abs(number);
            let parts = Number(number).toFixed(2).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return (isNegative ? '-' : '') + parts.join(',') + ' €';
        }

        const currencyElements = document.querySelectorAll('.fmt-currency');

        currencyElements.forEach(el => {
            let rawData = el.getAttribute('data-val');
            if (rawData) {
                rawData = rawData.replace(',', '.');
            }
            const rawVal = parseFloat(rawData);
            el.textContent = formatEuro(rawVal);
        });

        const rawData = {{ grafico_json|safe }};

        const labels = rawData.map(d => d.date);
        const investito = rawData.map(d => d.investito);
        const valore = rawData.map(d => d.valore);

        const ctx = document.getElementById('pacChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Valore Totale (Asset + Cash)',
                        data: valore,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        hitRadius: 10
                    },
                    {
                        label: 'Capitale Versato',
                        data: investito,
                        borderColor: '#94a3b8',
                        borderDash: [5, 5],
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        hitRadius: 10
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatEuro(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 8, maxRotation: 0 }
                    },
                    y: {
                        grid: { borderDash: [2, 4], color: '#f1f5f9' },
                        ticks: {
                            callback: function(value) {
                                return '€' + (value / 1000).toFixed(0) + 'k';
                            }
                        }
                    }
                }
            }
        });
    });
</script>

<style>
    .chart-wrapper {
        position: relative;
        width: 100%;
        height: 450px;
        overflow: hidden;
    }

    @media (max-width: 768px) {
        .card-chart { padding: 10px !important; }
        .chart-wrapper { height: 300px; }
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: #fff;
        color: #64748b;
        padding: 8px 16px;
        border-radius: 99px;
        border: 1px solid #e2e8f0;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.2s ease;
        margin-bottom: 1rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .btn-back:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
        color: #334155;
        transform: translateX(-2px);
    }

    .custom-tooltip {
        position: relative;
        display: inline-block;
    }
    .custom-tooltip .tooltip-text {
        visibility: hidden;
        width: 240px;
        background-color: #1e293b;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 10;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 0.75rem;
        line-height: 1.4;
        font-weight: normal;
        box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.2);
        pointer-events: none;
    }
    .custom-tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
    }
    .custom-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
        bottom: 140%;
    }
</style>
{% endblock %}
